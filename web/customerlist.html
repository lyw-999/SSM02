<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>客户信息管理</title>
    <script src="layui-v2.5.6/layui/layui.js"></script>
    <link rel="stylesheet" href="layui-v2.5.6/layui/css/layui.css">
</head>
<body>
<!--我是修改的界面-->
<script type="text/html" id="updateHtml">
    <form class="layui-form layui-form-pane"  action="" onsubmit="return false" lay-filter="updateHtml">

        <div class="layui-form-item" >
            <label class="layui-form-label" >客户名</label>
            <div class="layui-input-inline"  >
                <input type="text" name="cust_name" placeholder="请输入姓名" class="layui-input" >
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label" >客户公司</label>
            <div class="layui-input-inline" >
                <input type="text" name="cust_company" placeholder="请输入公司名" class="layui-input" >
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label">客户手机号</label>
            <div class="layui-input-inline" >
                <input type="text" name="cust_phone" placeholder="请输入手机号" class="layui-input" >
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label" >客户职位</label>
            <div class="layui-input-inline"  >
                <input type="text" name="cust_position" placeholder="请输入职位" class="layui-input" >
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label">客户生日</label>
            <div class="layui-input-inline"  >
                <input type="text" name="cust_birth" class="layui-input" id="update_birth"
                       placeholder="yyyy-MM-dd HH:mm:ss">
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label">客户描述</label>
            <div class="layui-input-block"  >
                <textarea name="cust_desc" placeholder="请输入内容" class="layui-textarea"> </textarea>
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label">客户性别</label>
            <div class="layui-input-inline">
                <input type="radio" name="cust_sex" value="1" title="男" checked="">
                <input type="radio" name="cust_sex" value="2" title="女" >
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label">拜访人</label>
            <div class="layui-input-inline"  >
                <select name="user_id" lay-filter="user_id"  id="">
                    <option value="" selected="">请选择</option>
                    <!--                <option value="1"  >从后台查询</option>-->
                    <!--                <option value="2"  >查询非管理员</option>-->
                </select>
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label">拜访时间</label>
            <div class="layui-input-inline"  >
                <input type="text" name="create_time" class="layui-input" id="updatevisitTime"
                       placeholder="yyyy-MM-dd HH:mm:ss">
            </div>
        </div>
        <!--        <div class="layui-form-item" >-->
        <!--        <div class="layui-input-inline">-->
        <!--            <button type="submit" class="layui-btn" lay-submit="" lay-filter="addBtn">添加</button>-->
        <!--        </div>-->
        <!--        </div>-->

        <!--          下面应该有一个提交或者修改的按钮-->
        <!--  这是 隐藏的  <input class="layui-input" type="hidden" value="" name="user_id">-->
        <div class="layui-input-inline">
            <button type="submit" class="layui-btn" lay-submit=""  id="myupdateSubmit" lay-filter="myupdateSubmit">确定修改</button>
        </div>
    </form>
</script>
<!--我是拜访的界面-->
<script type="text/html" id="baifangHtml">

    <form class="layui-form layui-form-pane"  action="" onsubmit="return false" lay-filter="baifangHtml">

        <div class="layui-form-item" >
            <label class="layui-form-label">客户名称</label>
            <div class="layui-input-inline"  >
                <input type="text" name="cust_name" class="layui-input"  >
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label">拜访时间</label>
            <div class="layui-input-inline"  >
                <input type="text" name="visit_time" class="layui-input" id="visit_time"
                       placeholder="拜访时间">
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label">拜访情况</label>
            <div class="layui-input-block"  >
                <textarea name="visit_desc" placeholder="请输入内容" class="layui-textarea"> </textarea>
            </div>
        </div>

        <input class="layui-input" type="hidden" value="" name="user_id">
        <input class="layui-input" type="hidden" value="" name="id">
        <button   class="layui-btn layui-hide" lay-submit=""  id="mybaiFangSubmit" lay-filter="mybaiFangSubmit">提交</button>
    </form>
</script>
<!--我是添加的界面-->
<script type="text/html" id="addHtml">
        <form class="layui-form layui-form-pane"  action="" onsubmit="return false" lay-filter="addHtml">

        <div class="layui-form-item" >
        <label class="layui-form-label" >客户名</label>
        <div class="layui-input-inline"  >
            <input type="text" name="cust_name" placeholder="请输入姓名" class="layui-input" >
        </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label" >客户公司</label>
            <div class="layui-input-inline" >
                <input type="text" name="cust_company" placeholder="请输入公司名" class="layui-input" >
        </div>
        </div>

        <div class="layui-form-item" >
        <label class="layui-form-label">客户手机号</label>
        <div class="layui-input-inline" >
            <input type="text" name="cust_phone" placeholder="请输入手机号" class="layui-input" >
        </div>
        </div>

        <div class="layui-form-item" >
             <label class="layui-form-label" >客户职位</label>
             <div class="layui-input-inline"  >
                    <input type="text" name="cust_position" placeholder="请输入职位" class="layui-input" >
             </div>
        </div>

        <div class="layui-form-item" >
        <label class="layui-form-label">客户生日</label>
                <div class="layui-input-inline"  >
                    <input type="text" name="cust_birth" class="layui-input" id="cust_birth"
                               placeholder="yyyy-MM-dd HH:mm:ss">
        </div>
        </div>

         <div class="layui-form-item" >
         <label class="layui-form-label">客户描述</label>
             <div class="layui-input-block"  >
                <textarea name="cust_desc" placeholder="请输入内容" class="layui-textarea"> </textarea>
        </div>
        </div>

        <div class="layui-form-item" >
        <label class="layui-form-label">客户性别</label>
         <div class="layui-input-inline">
            <input type="radio" name="cust_sex" value="1" title="男" checked="">
            <input type="radio" name="cust_sex" value="2" title="女" >
        </div>
        </div>

        <div class="layui-form-item" >
        <label class="layui-form-label">拜访人</label>
        <div class="layui-input-inline"  >
            <select name="user_id" lay-filter="user_id"  id="user_id">
                <option value="" selected="">请选择</option>
<!--                <option value="1"  >从后台查询</option>-->
<!--                <option value="2"  >查询非管理员</option>-->
            </select>
        </div>
        </div>

        <div class="layui-form-item" >
        <label class="layui-form-label">拜访时间</label>
        <div class="layui-input-inline"  >
            <input type="text" name="create_time" class="layui-input" id="visitTime"
                   placeholder="yyyy-MM-dd HH:mm:ss">
        </div>
        </div>
<!--        <div class="layui-form-item" >-->
<!--        <div class="layui-input-inline">-->
<!--            <button type="submit" class="layui-btn" lay-submit="" lay-filter="addBtn">添加</button>-->
<!--        </div>-->
<!--        </div>-->

    <!--          下面应该有一个提交或者修改的按钮-->
<!--  这是 隐藏的  <input class="layui-input" type="hidden" value="" name="user_id">-->
    <div class="layui-input-inline">
        <button type="submit" class="layui-btn" lay-submit=""  id="myAddSubmit" lay-filter="myAddSubmit">确定添加</button>
    </div>
</form>
</script>

<!--     添加一个搜索框-->
<form class="layui-form layui-form-pane"  action="" onsubmit="return false" >

    <div class="layui-form-item" >
        <label class="layui-form-label" >客户名</label>
        <div class="layui-input-inline" style="width: 110px">
            <input type="text" name="cust_name" placeholder="请输入姓名" class="layui-input" >
        </div>


        <label class="layui-form-label">客户手机号</label>
        <div class="layui-input-inline" style="width: 130px">
            <input type="text" name="cust_phone" placeholder="请输入手机号" class="layui-input" >
        </div>

        <label class="layui-form-label">客户性别</label>
        <div class="layui-input-inline" style="width: 110px">
            <select name="cust_sex">
                <option value="" selected="">请选择</option>
                <option value="1">男</option>
                <option value="2">女</option>
            </select>
        </div>

        <label class="layui-form-label">拜访人</label>
        <div class="layui-input-inline" style="width: 115px">
            <input type="text" name="username" placeholder="请输入拜访人" class="layui-input" >
        </div>


        <label class="layui-form-label">拜访时间</label>
        <div class="layui-input-inline" style="width: 160px">
            <input type="text" name="modify_time" class="layui-input" id="modifyTime"
                   placeholder="yyyy-MM-dd HH:mm:ss">
        </div>

        <div class="layui-input-inline">
            <button type="submit" class="layui-btn" lay-submit="" lay-filter="ssBtn">搜索</button>
        </div>
    </div>

    <!--          下面应该有一个提交或者修改的按钮-->
</form>
<table class="layui-hide" id="test" lay-filter="test"></table>

<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="getCheckData">获取选中行数据</button>
        <button class="layui-btn layui-btn-sm" lay-event="getCheckLength">获取选中数目</button>
        <button class="layui-btn layui-btn-sm" lay-event="isAll">验证是否全选</button>

        <button class="layui-btn layui-btn-sm" lay-event="insert">添加</button>
        <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="delAll">批量删除</button>
    </div>
</script>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="lookCustomer">拜访记录</a>
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>

</script>

<script>
    layui.use(['form','table','util','jquery','laydate'],function(args){

        var form = layui.form;
        var table = layui.table;
        var util = layui.util;
        var $ = layui.jquery;
        var laydate = layui.laydate;

        //日期时间选择器
        laydate.render({
            elem: '#modifyTime'
            ,type: 'datetime'
        });


        // table.render 是渲染 上面的 table 表格
       // xr()

      //  function xr() {

            table.render({
                elem: '#test'
                // ,url:'/test/table/demo1.json'
                , url: '/CustSelectServlet'
                , toolbar: '#toolbarDemo' //开启头部工具栏，并为其绑定左侧模板
                , defaultToolbar: ['filter', 'exports', 'print', { //自定义头部工具栏右侧图标。如无需自定义，去除该参数即可
                    title: '提示'
                    , layEvent: 'LAYTABLE_TIPS'
                    , icon: 'layui-icon-tips'
                }]
                , title: '客户数据表'
                , cols: [[
                    {type: 'checkbox', fixed: 'left'}
                    , {field: 'id', title: '编号', align: "center", width: 80, fixed: 'left', edit: 'text', sort: true}
                    , {field: 'cust_name', title: '客户名', align: "center", width: 85}
                    , {field: 'cust_company', title: '客户公司', align: "center", width: 90}
                    , {field: 'cust_birth', title: '客户生日', align: "center", width: 100}
                    , {field: 'cust_sex', title: '客户性别', align: "center", width: 90 ,templet:function (d) {
                                if(d.cust_sex=="1"){
                                    return "<span style='color: red'>男</span>"
                                }else{
                                    return "<span style='color: greenyellow'>女</span>"
                                }
                    }}

                    , {field: 'cust_phone', title: '客户手机号', align: "center", width: 120}
                    , {field: 'cust_position', title: '客户的职务', align: "center", width: 100}
                    , {field: 'username', title: '业务员名字', align: "center", width: 100}
                    , {field: 'user_id', title: '业务员id', align: "center", width: 100  ,hide:true }
                    , {field: 'create_time', title: '第一次拜访时间', align: "center", width: 135}
                    , {field: 'modify_time', title: '最后一次拜访时间', align: "center", width: 145}

                    // ,{field:'birthday', title:'出生日期', width:250,templet:function (d) {
                    //         console.log(d)
                    //         // d 就是这一行数据, 拿到这个数据就可以进行一个修改
                    //         //util.toDateString(d.birthday, "yyyy-MM-dd HH:mm:ss");
                    //         return util.toDateString(d.birthday, "yyyy-MM-dd HH:mm:ss");;
                    //     } }
                    // ,{field: 'shen', title:'是否是神仙',width:150 , templet: function (d){
                    //         if (d.shen){
                    //             return  "<input type=\"checkbox\" checked=\"\" name=\"open\" lay-skin=\"switch\" lay-filter=\"switchTest\" lay-text=\"神仙|凡人\" value='神仙'>"
                    //         }else{
                    //             return  "<input type=\"checkbox\"              name=\"close\" lay-skin=\"switch\"  lay-filter=\"switchTest\" lay-text=\"神仙|凡人\" value='凡人'>"
                    //         }}}
                    , {fixed: 'right', title: '操作',align: "center", toolbar: '#barDemo', width: 200}
                ]]

                , page: true

            });

      //  }
        //头工具栏事件
        table.on('toolbar(test)', function(obj){
            var checkStatus = table.checkStatus(obj.config.id);
            switch(obj.event) {
                case 'getCheckData':
                    var data = checkStatus.data;
                    layer.alert(JSON.stringify(data));
                    break;
                case 'getCheckLength':
                    var data = checkStatus.data;
                    layer.msg('选中了：' + data.length + ' 个');
                    break;
                case 'isAll':
                    layer.msg(checkStatus.isAll ? '全选' : '未全选');

                    break;
                case 'insert':

                    //定义一个空对象，作为open函数的参数
                    var data = checkStatus.data;
                    layer.open({
                        type: "添加",
                        area: ['600px', '600px'],
                        type: 1,
                        // content: '传入任意的文本或html' //这里content是一个普通的String
                        content: $("#addHtml").html(),
                        success: function (layero, index) {
                            console.log(layero)
                            console.log(index)
                            console.log("我是layer添加的回调")
                            //alert("给我添加")

                            form.render();//重点:强调当界面发生改变时 记得重新渲染模块，不然不显示效果

                            //查询拜访人
                            // form.on('select(user_id)',function (data) {
                            //     console.log(data.elem);
                            //     console.log(data.value);
                            //     console.log(data.this);
                            // })
                            //日期时间选择器
                            laydate.render({
                                elem: '#visitTime'
                            });
                            //日期时间选择器
                            laydate.render({
                                elem: '#cust_birth'
                            });

                            //请求 数据 发送Ajax 得到数据后渲染到 select框中
                            $.ajax({
                                url:'/UserSelectTypeServlet',
                                type:'get',
                                dataType:'json',
                                success:function (res) {
                                    console.log(res)
                                    var select =$("#user_id")
                                    $.each( res.data, function (index, item) {
                                        select.append(new Option( item.real_name, item.id));//下拉菜单里添加元素
                                     });
                                    layui.form.render("select");
                                }
                            });
                        },

                        //重点:强调当界面发生改变时 记得重新渲染模块，不然不显示效果
                        btn: ['确定添加', '取消添加', '退出']
                        , yes: function (index, layero) {
                            alert(data);
                            return false  // 开启该代码可禁止点击该按钮关闭
                        }, n: function (index, layero) {
                            alert("取消添加");
                            return false  // 开启该代码可禁止点击该按钮关闭
                        }
                    });
                    // layer.msg("这里写添加");
                    break;

                case  'delAll':
                    //layer.msg("这里是全选删除")
                    var data = checkStatus.data;// 这是选中过的数据
                    // data是数组  进行遍历.
                    var ids = new Array();

                    $.each(data, function (index, item) {
                        //console. log(item. id)
                        ids.push(item.id);
                    })
                    console.log(ids)
                    if(ids.length <=0){
                        layer.msg("请选中一行数据",{icon:5})
                    }else {
                        // 使用. ajax. 把微组传入到后台
                        layer.confirm('确认删除吗?此操作不可恢复', {icon: 3, title: '确定删除?'}, function (index) {
                          //  console.log("发送了ajax.进行批量删除")
                              $.ajax({
                                url:'/CustomerDeleteAllServlet',
                                type:'post',
                                data:{"ids":ids},
                                dataType:'JSON',
                                success:function (res) {
                                      console.log(res)
                                    if(res.code == 0){
                                        layer.msg("删除成功",{icon: 2})
                                        table.reload('test',{
                                            page:{
                                                curr:  1
                                            }
                                        });
                                    }
                                  }
                            });
                            layer.close(index)
                        });
                    }
                    break;

                //自定义头工具栏右侧图标 - 提示
                case 'LAYTABLE_TIPS':
                    layer.alert('这是工具栏右侧自定义的一个图标按钮');
                    break;

            };
        }); 
        //监听行工具事件
        table.on('tool(test)', function(obj){
            var data = obj.data;
            //console.log(obj)
            if(obj.event === 'del'){
                layer.confirm('真的删除行么', function(index){
                    $.ajax({
                        url: '/CustomerDeleteServlet',
                        type: 'post',
                        data: {
                            "id":data.id
                        },
                        dataType: 'json'
                    });
                    obj.del();
                    layer.close(index);
                    layer.msg("删除成功")

                });
            } else if(obj.event === 'edit'){
                layer.open({
                    type: "编辑",
                    area: ['600px', '600px'],
                    type: 1,
                    // content: '传入任意的文本或html' //这里content是一个普通的String
                    content: $("#updateHtml").html(),
                    success:function (layero,index){
                        console.log(layero)
                        console.log(index)
                        console.log("我是layer弹出后的回调")
                       //alert("谈不谈你")


                        form.render();  // 重点:强调: 当界面发生改变时, 记得 重新渲染模块,不然不显示效果

                        //日期时间选择器
                        laydate.render({
                            elem: '#updateTime'
                            ,type: 'datetime'
                        });


                    },
                    btn:['确定修改','取消修改','其他1','其他2'],
                    yes:function (index, layero) {
                        alert("我要来修改")
                        return false //开启该代码可禁止点击该按钮关闭
                    },btn2: function(index, layero){
                        alert("我取消了修改")
                        return false  // 开启该代码可禁止点击该按钮关闭
                    }
                });
                // layer.prompt({
                //     formType: 2
                //     ,value: data.email
                // }, function(value, index){
                //     obj.update({
                //         email: value
                //     });
                //     layer.close(index);
                // });
            }else if(obj.event === 'lookCustomer'){

                //alert("我要写拜访记录")
                layer.open({
                    type: "拜访记录",
                    area: ['600px', '600px'],
                    type: 1,
                    // content: '传入任意的文本或html' //这里content是一个普通的String
                    content: $("#baifangHtml").html(),
                    success:function (layero,index){
                        console.log("将来要 赋值到表单中的名字")
                        console.log(data.id)
                        console.log(data.user_id)
                        console.log(data.cust_name)


                        form.val('baifangHtml',{
                            "id":data.id,
                            "user_id":data.user_id,
                            "cust_name":data.cust_name,
                        });
                        form.render();  // 重点:强调: 当界面发生改变时, 记得 重新渲染模块,不然不显示效果

                        //日期时间选择器
                        laydate.render({
                            elem: '#visit_time'
                            //,type: 'datetime'
                        });

                    },
                    btn:['确定拜访','取消拜访' ],
                    yes:function (index, layero) {
                       $("#mybaiFangSubmit").click();
                        return false //开启该代码可禁止点击该按钮关闭
                    },btn2: function(index, layero){
                      //  return false  // 开启该代码可禁止点击该按钮关闭
                    }
                });
            }
        });

        //  监听添加事件
        form.on('submit(myAddSubmit)', function(data){
            console.log(data);
            $.ajax({
                url: '/CustomerInsertServlet',
                type: 'post',
                data: data.field,
                dataType: 'JSON',
                success:function (res) {
                    console.log(res)
                    if(res.code == 0){
                        layer.msg("添加成功");
                        table.reload('test',{
                            page:{
                                curr : 1//重新从第 1 页开始
                            }
                        });//只重载数据
                    }
                }
            });

        });

        // 监听 搜索开关
        form.on('submit(ssBtn)', function(data) {
               // alert("点击了搜索")
                console.log(data.field)
                table.reload('test',{
                where: {//设定异步数据接口的额外参数，任意设
                    cust_name: data.field.cust_name
                   , cust_phone: data.field.cust_phone
                    , cust_sex: data.field.cust_sex
                    , username: data.field.username
                    , modify_time: data.field.modify_time

                }
                , page: {
                        curr: 1 //重新从第.1.页开始
                    }
                }); //只重载数据
            return   false;
        });

        //  监听拜访事件
        form.on('submit(mybaiFangSubmit)', function(data){
            console.log(data);
            $.ajax({
                url: '/VisitInsertServlet',
                type: 'post',
                data: data.field,
                dataType: 'JSON',
                success:function (res) {
                    console.log(res)
                    if(res.code == 0){
                        layer.msg("拜访成功");
                        table.reload('test',{
                            page:{
                                curr : 1//重新从第 1 页开始
                            }
                        });//只重载数据
                    }
                }
            });

        });
    });

</script>
</body>
</html>
